#!/usr/bin/env bash

cmd=$1
opt=$2
url=$3

if [ "$cmd"x == "install"x ];then
    echo "init api-gen..."
    (cd cli-tools/api-gen && npm install)
    echo "init pretty-json..."
    (cd cli-tools/pretty-json && npm install )
    echo "init zero-json..."
    (cd cli-tools/zero-json && npm install)
    echo "init env-test..."
    npm install
    initDir
    exit 0
elif [ "$cmd"x == "get"x -a "$opt"x == "swagger"x ];then
    (cd cli-tools/zero-json && \
    curl $url --out swagger/index.json && \
    node index.js swagger format && mv swagger/format.json ../../pub/swagger.json)
    exit 0
elif [ "$cmd"x == "update"x ];then
    echo "update api-gen..."
    (cd cli-tools/api-gen && npm install)
    echo "update pretty-json..."
    (cd cli-tools/pretty-json && npm install )
    echo "update zero-json..."
    (cd cli-tools/zero-json && npm install)
    echo "update env-test..."
    npm install
    exit 0
elif [ "$cmd"x == "repair"x ];then
    if [ ! -f "package-lock.json" ];then
        rm package-lock.json
    fi
    if [ ! -f "./cli-tools/api-gen/package-lock.json" ];then
        rm ./cli-tools/api-gen/package-lock.json
    fi
    if [ ! -f "./cli-tools/pretty-json/package-lock.json" ];then
        rm ./cli-tools/pretty-json/package-lock.json
    fi
    if [ ! -f "./cli-tools/zero-json/package-lock.json" ];then
        rm ./cli-tools/zero-json/package-lock.json
    fi
    echo "repair api-gen..."
    (cd cli-tools/api-gen && npm uninstall api-gen -g && npm install)
    echo "repair pretty-json..."
    (cd cli-tools/pretty-json && npm uninstall pretty-json -g && npm install )
    echo "repair zero-json..."
    (cd cli-tools/zero-json && npm uninstall zero-json -g && npm install)
    echo "repair env-test..."
    npm unstall env-test && npm install
    initDir
    exit 0
fi

initDir() {
    echo "init  dir.."
    if [ ! -d "./cli-tools/zero-json/swagger" ];then
        mkdir ./cli-tools/zero-json/swagger
    fi
    if [ ! -d "./pub" ];then
        mkdir swagger
    fi
    if [ ! -d "./pub/logs" ];then
        mkdir pub/logs
    fi
    if [ ! -d "./temp" ];then
        mkdir temp
    fi
}
echo "Usage: ./init [install | update | repair | get swagger <url>]";
